{% extends "base.html" %}

{% block title %}Settings - Fantasy Football ML Draft System{% endblock %}

{% block content %}
<div class="card">
    <h2>League Settings</h2>
    <p>Configure your league settings to optimize recommendations and projections.</p>
</div>

<!-- League Configuration -->
<div class="card">
    <h3>League Configuration</h3>
    <form id="league-settings-form">
        <div class="grid grid-2">
            <div>
                <div class="form-group">
                    <label for="teams">Number of Teams:</label>
                    <select id="teams" class="form-control" name="teams">
                        <option value="8">8 Teams</option>
                        <option value="10">10 Teams</option>
                        <option value="12">12 Teams</option>
                        <option value="14">14 Teams</option>
                        <option value="16">16 Teams</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scoring">Scoring System:</label>
                    <select id="scoring" class="form-control" name="scoring">
                        <option value="ppr">PPR (Point Per Reception)</option>
                        <option value="half_ppr">Half PPR (0.5 per reception)</option>
                        <option value="standard">Standard (No PPR)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="current-week">Current Week:</label>
                    <select id="current-week" class="form-control" name="current_week">
                        <option value="1">Week 1 (Draft Season)</option>
                        <option value="2">Week 2</option>
                        <option value="3">Week 3</option>
                        <option value="4">Week 4</option>
                        <option value="5">Week 5</option>
                        <option value="6">Week 6</option>
                        <option value="7">Week 7</option>
                        <option value="8">Week 8</option>
                        <option value="9">Week 9</option>
                        <option value="10">Week 10</option>
                        <option value="11">Week 11</option>
                        <option value="12">Week 12</option>
                        <option value="13">Week 13</option>
                        <option value="14">Week 14</option>
                        <option value="15">Week 15</option>
                        <option value="16">Week 16</option>
                        <option value="17">Week 17</option>
                        <option value="18">Week 18</option>
                    </select>
                </div>
            </div>
            
            <div>
                <div class="form-group">
                    <label for="playoff-teams">Playoff Teams:</label>
                    <select id="playoff-teams" class="form-control" name="playoff_teams">
                        <option value="4">4 Teams</option>
                        <option value="6">6 Teams</option>
                        <option value="8">8 Teams</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="playoff-start">Playoff Start Week:</label>
                    <select id="playoff-start" class="form-control" name="playoff_start">
                        <option value="14">Week 14</option>
                        <option value="15">Week 15</option>
                        <option value="16">Week 16</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="trade-deadline">Trade Deadline Week:</label>
                    <select id="trade-deadline" class="form-control" name="trade_deadline">
                        <option value="10">Week 10</option>
                        <option value="11">Week 11</option>
                        <option value="12">Week 12</option>
                        <option value="13">Week 13</option>
                    </select>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Roster Configuration -->
<div class="card">
    <h3>Roster Configuration</h3>
    <div class="grid grid-2">
        <div>
            <h4>Starting Lineup</h4>
            <div class="form-group">
                <label for="qb-spots">Quarterback (QB):</label>
                <select id="qb-spots" class="form-control" name="qb_spots">
                    <option value="1">1 QB</option>
                    <option value="2">2 QB (Superflex)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="rb-spots">Running Back (RB):</label>
                <select id="rb-spots" class="form-control" name="rb_spots">
                    <option value="1">1 RB</option>
                    <option value="2">2 RB</option>
                    <option value="3">3 RB</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="wr-spots">Wide Receiver (WR):</label>
                <select id="wr-spots" class="form-control" name="wr_spots">
                    <option value="1">1 WR</option>
                    <option value="2">2 WR</option>
                    <option value="3">3 WR</option>
                    <option value="4">4 WR</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="te-spots">Tight End (TE):</label>
                <select id="te-spots" class="form-control" name="te_spots">
                    <option value="1">1 TE</option>
                    <option value="2">2 TE</option>
                </select>
            </div>
        </div>
        
        <div>
            <h4>Flex & Special Positions</h4>
            <div class="form-group">
                <label for="flex-spots">Flex (RB/WR/TE):</label>
                <select id="flex-spots" class="form-control" name="flex_spots">
                    <option value="0">0 Flex</option>
                    <option value="1">1 Flex</option>
                    <option value="2">2 Flex</option>
                    <option value="3">3 Flex</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="k-spots">Kicker (K):</label>
                <select id="k-spots" class="form-control" name="k_spots">
                    <option value="0">No Kicker</option>
                    <option value="1">1 Kicker</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="def-spots">Defense/ST (DEF):</label>
                <select id="def-spots" class="form-control" name="def_spots">
                    <option value="0">No Defense</option>
                    <option value="1">1 Defense</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="bench-spots">Bench Spots:</label>
                <select id="bench-spots" class="form-control" name="bench_spots">
                    <option value="4">4 Bench</option>
                    <option value="5">5 Bench</option>
                    <option value="6">6 Bench</option>
                    <option value="7">7 Bench</option>
                    <option value="8">8 Bench</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Scoring Settings -->
<div class="card">
    <h3>Advanced Scoring Settings</h3>
    <div class="grid grid-2">
        <div>
            <h4>Passing</h4>
            <div class="form-group">
                <label for="pass-td">Passing TD:</label>
                <input type="number" id="pass-td" class="form-control" name="pass_td" value="4" step="0.5" min="0" max="10">
            </div>
            
            <div class="form-group">
                <label for="pass-yards">Passing Yards (per yard):</label>
                <input type="number" id="pass-yards" class="form-control" name="pass_yards" value="0.04" step="0.01" min="0" max="1">
            </div>
            
            <div class="form-group">
                <label for="pass-int">Interceptions:</label>
                <input type="number" id="pass-int" class="form-control" name="pass_int" value="-2" step="0.5" min="-10" max="0">
            </div>
        </div>
        
        <div>
            <h4>Rushing/Receiving</h4>
            <div class="form-group">
                <label for="rush-rec-td">Rushing/Receiving TD:</label>
                <input type="number" id="rush-rec-td" class="form-control" name="rush_rec_td" value="6" step="0.5" min="0" max="10">
            </div>
            
            <div class="form-group">
                <label for="rush-rec-yards">Rush/Rec Yards (per yard):</label>
                <input type="number" id="rush-rec-yards" class="form-control" name="rush_rec_yards" value="0.1" step="0.01" min="0" max="1">
            </div>
            
            <div class="form-group">
                <label for="fumbles">Fumbles Lost:</label>
                <input type="number" id="fumbles" class="form-control" name="fumbles" value="-2" step="0.5" min="-10" max="0">
            </div>
        </div>
    </div>
</div>

<!-- AI Advisor Settings -->
<div class="card">
    <h3>AI Advisor Settings</h3>
    <div class="grid grid-2">
        <div>
            <div class="form-group">
                <label for="advice-style">Advice Style:</label>
                <select id="advice-style" class="form-control" name="advice_style">
                    <option value="balanced">Balanced (Conservative + Aggressive)</option>
                    <option value="conservative">Conservative (Safe picks)</option>
                    <option value="aggressive">Aggressive (High upside)</option>
                    <option value="analytical">Analytical (Data-focused)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="risk-tolerance">Risk Tolerance:</label>
                <select id="risk-tolerance" class="form-control" name="risk_tolerance">
                    <option value="low">Low (Safe floor players)</option>
                    <option value="medium">Medium (Balanced approach)</option>
                    <option value="high">High (High ceiling players)</option>
                </select>
            </div>
        </div>
        
        <div>
            <div class="form-group">
                <label for="draft-strategy">Draft Strategy Focus:</label>
                <select id="draft-strategy" class="form-control" name="draft_strategy">
                    <option value="vbd">Value-Based Drafting</option>
                    <option value="position_scarcity">Position Scarcity</option>
                    <option value="best_available">Best Player Available</option>
                    <option value="balanced_roster">Balanced Roster Building</option>
                </select>
            </div>
            
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="injury-averse" name="injury_averse">
                    <label for="injury-averse">Avoid injury-prone players</label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="card">
    <div class="grid grid-3">
        <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
        <button class="btn btn-secondary" onclick="loadDefaultSettings()">Load Defaults</button>
        <button class="btn btn-warning" onclick="exportSettings()">Export Settings</button>
    </div>
    <div id="settings-status"></div>
</div>

<!-- Import Settings -->
<div class="card">
    <h3>Import/Export Settings</h3>
    <div class="grid grid-2">
        <div>
            <h4>Import Settings</h4>
            <div class="form-group">
                <label for="settings-file">Import Settings File:</label>
                <input type="file" id="settings-file" class="form-control" accept=".json" onchange="importSettings()">
            </div>
        </div>
        <div>
            <h4>Quick Setup</h4>
            <p>Load common league configurations:</p>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="loadPreset('standard_12')">Standard 12-team PPR</button>
                <button class="btn btn-secondary" onclick="loadPreset('superflex_12')">12-team Superflex</button>
                <button class="btn btn-secondary" onclick="loadPreset('dynasty_12')">Dynasty 12-team</button>
            </div>
        </div>
    </div>
</div>

<!-- System Information -->
<div class="card">
    <h3>System Information</h3>
    <div id="system-info">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading system information...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSettings = {};

// Initialize settings page
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentSettings();
    loadSystemInfo();
});

async function loadCurrentSettings() {
    try {
        const response = await fetch('/api/league-settings');
        const settings = await response.json();
        
        currentSettings = settings;
        populateForm(settings);
        
    } catch (error) {
        console.error('Error loading settings:', error);
        document.getElementById('settings-status').innerHTML = 
            '<div class="alert alert-error">Error loading current settings</div>';
    }
}

function populateForm(settings) {
    // League configuration
    if (settings.teams) document.getElementById('teams').value = settings.teams;
    if (settings.scoring) document.getElementById('scoring').value = settings.scoring;
    if (settings.current_week) document.getElementById('current-week').value = settings.current_week;
    if (settings.playoff_teams) document.getElementById('playoff-teams').value = settings.playoff_teams;
    if (settings.playoff_start) document.getElementById('playoff-start').value = settings.playoff_start;
    if (settings.trade_deadline) document.getElementById('trade-deadline').value = settings.trade_deadline;
    
    // Roster configuration
    if (settings.qb_spots) document.getElementById('qb-spots').value = settings.qb_spots;
    if (settings.rb_spots) document.getElementById('rb-spots').value = settings.rb_spots;
    if (settings.wr_spots) document.getElementById('wr-spots').value = settings.wr_spots;
    if (settings.te_spots) document.getElementById('te-spots').value = settings.te_spots;
    if (settings.flex_spots) document.getElementById('flex-spots').value = settings.flex_spots;
    if (settings.k_spots) document.getElementById('k-spots').value = settings.k_spots;
    if (settings.def_spots) document.getElementById('def-spots').value = settings.def_spots;
    if (settings.bench_spots) document.getElementById('bench-spots').value = settings.bench_spots;
    
    // Scoring settings
    if (settings.pass_td) document.getElementById('pass-td').value = settings.pass_td;
    if (settings.pass_yards) document.getElementById('pass-yards').value = settings.pass_yards;
    if (settings.pass_int) document.getElementById('pass-int').value = settings.pass_int;
    if (settings.rush_rec_td) document.getElementById('rush-rec-td').value = settings.rush_rec_td;
    if (settings.rush_rec_yards) document.getElementById('rush-rec-yards').value = settings.rush_rec_yards;
    if (settings.fumbles) document.getElementById('fumbles').value = settings.fumbles;
    
    // AI settings
    if (settings.advice_style) document.getElementById('advice-style').value = settings.advice_style;
    if (settings.risk_tolerance) document.getElementById('risk-tolerance').value = settings.risk_tolerance;
    if (settings.draft_strategy) document.getElementById('draft-strategy').value = settings.draft_strategy;
    if (settings.injury_averse) document.getElementById('injury-averse').checked = settings.injury_averse;
}

function gatherFormData() {
    const formData = {
        // League configuration
        teams: parseInt(document.getElementById('teams').value),
        scoring: document.getElementById('scoring').value,
        current_week: parseInt(document.getElementById('current-week').value),
        playoff_teams: parseInt(document.getElementById('playoff-teams').value),
        playoff_start: parseInt(document.getElementById('playoff-start').value),
        trade_deadline: parseInt(document.getElementById('trade-deadline').value),
        
        // Roster configuration
        qb_spots: parseInt(document.getElementById('qb-spots').value),
        rb_spots: parseInt(document.getElementById('rb-spots').value),
        wr_spots: parseInt(document.getElementById('wr-spots').value),
        te_spots: parseInt(document.getElementById('te-spots').value),
        flex_spots: parseInt(document.getElementById('flex-spots').value),
        k_spots: parseInt(document.getElementById('k-spots').value),
        def_spots: parseInt(document.getElementById('def-spots').value),
        bench_spots: parseInt(document.getElementById('bench-spots').value),
        
        // Scoring settings
        pass_td: parseFloat(document.getElementById('pass-td').value),
        pass_yards: parseFloat(document.getElementById('pass-yards').value),
        pass_int: parseFloat(document.getElementById('pass-int').value),
        rush_rec_td: parseFloat(document.getElementById('rush-rec-td').value),
        rush_rec_yards: parseFloat(document.getElementById('rush-rec-yards').value),
        fumbles: parseFloat(document.getElementById('fumbles').value),
        
        // AI settings
        advice_style: document.getElementById('advice-style').value,
        risk_tolerance: document.getElementById('risk-tolerance').value,
        draft_strategy: document.getElementById('draft-strategy').value,
        injury_averse: document.getElementById('injury-averse').checked
    };
    
    // Calculate roster spots for compatibility
    formData.roster_spots = {
        QB: formData.qb_spots,
        RB: formData.rb_spots,
        WR: formData.wr_spots,
        TE: formData.te_spots,
        FLEX: formData.flex_spots,
        K: formData.k_spots,
        DEF: formData.def_spots,
        BENCH: formData.bench_spots
    };
    
    return formData;
}

async function saveSettings() {
    const formData = gatherFormData();
    const statusDiv = document.getElementById('settings-status');
    
    statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Saving settings...</p></div>';
    
    try {
        const response = await fetch('/api/league-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success">Settings saved successfully!</div>';
            currentSettings = data.settings;
            
            // Clear status after 3 seconds
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
            
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
        
    } catch (error) {
        console.error('Error saving settings:', error);
        statusDiv.innerHTML = '<div class="alert alert-error">Network error occurred</div>';
    }
}

function loadDefaultSettings() {
    const defaults = {
        teams: 12,
        scoring: 'ppr',
        current_week: 1,
        playoff_teams: 6,
        playoff_start: 14,
        trade_deadline: 11,
        qb_spots: 1,
        rb_spots: 2,
        wr_spots: 2,
        te_spots: 1,
        flex_spots: 1,
        k_spots: 1,
        def_spots: 1,
        bench_spots: 6,
        pass_td: 4,
        pass_yards: 0.04,
        pass_int: -2,
        rush_rec_td: 6,
        rush_rec_yards: 0.1,
        fumbles: -2,
        advice_style: 'balanced',
        risk_tolerance: 'medium',
        draft_strategy: 'vbd',
        injury_averse: false
    };
    
    populateForm(defaults);
    document.getElementById('settings-status').innerHTML = 
        '<div class="alert alert-success">Default settings loaded. Click "Save Settings" to apply.</div>';
}

function loadPreset(presetName) {
    const presets = {
        'standard_12': {
            teams: 12,
            scoring: 'ppr',
            qb_spots: 1,
            rb_spots: 2,
            wr_spots: 2,
            te_spots: 1,
            flex_spots: 1,
            k_spots: 1,
            def_spots: 1,
            bench_spots: 6
        },
        'superflex_12': {
            teams: 12,
            scoring: 'ppr',
            qb_spots: 2,
            rb_spots: 2,
            wr_spots: 3,
            te_spots: 1,
            flex_spots: 2,
            k_spots: 1,
            def_spots: 1,
            bench_spots: 7
        },
        'dynasty_12': {
            teams: 12,
            scoring: 'ppr',
            qb_spots: 1,
            rb_spots: 2,
            wr_spots: 3,
            te_spots: 1,
            flex_spots: 2,
            k_spots: 0,
            def_spots: 0,
            bench_spots: 15
        }
    };
    
    const preset = presets[presetName];
    if (preset) {
        // Merge with current settings to preserve other values
        const mergedSettings = { ...currentSettings, ...preset };
        populateForm(mergedSettings);
        document.getElementById('settings-status').innerHTML = 
            `<div class="alert alert-success">Loaded ${presetName.replace('_', ' ')} preset. Click "Save Settings" to apply.</div>`;
    }
}

function exportSettings() {
    const settings = gatherFormData();
    const dataStr = JSON.stringify(settings, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'fantasy_league_settings.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    document.getElementById('settings-status').innerHTML = 
        '<div class="alert alert-success">Settings exported successfully!</div>';
}

function importSettings() {
    const fileInput = document.getElementById('settings-file');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const settings = JSON.parse(e.target.result);
            populateForm(settings);
            document.getElementById('settings-status').innerHTML = 
                '<div class="alert alert-success">Settings imported successfully. Click "Save Settings" to apply.</div>';
        } catch (error) {
            document.getElementById('settings-status').innerHTML = 
                '<div class="alert alert-error">Error parsing settings file</div>';
        }
    };
    
    reader.readAsText(file);
}

async function loadSystemInfo() {
    try {
        const response = await fetch('/api/status');
        const status = await response.json();
        
        let infoHtml = '<div class="grid grid-2">';
        
        // System status
        infoHtml += '<div>';
        infoHtml += '<h4>System Status</h4>';
        infoHtml += createStatusItem('System Initialized', status.system_initialized);
        infoHtml += createStatusItem('Models Trained', status.models_trained);
        infoHtml += createStatusItem('Projections Ready', status.projections_ready);
        infoHtml += createStatusItem('AI Advisor Available', status.claude_api_available);
        infoHtml += '</div>';
        
        // Current configuration
        infoHtml += '<div>';
        infoHtml += '<h4>Current Configuration</h4>';
        if (status.league_settings) {
            const settings = status.league_settings;
            infoHtml += `<p><strong>Teams:</strong> ${settings.teams || 'Not set'}</p>`;
            infoHtml += `<p><strong>Scoring:</strong> ${settings.scoring || 'Not set'}</p>`;
            infoHtml += `<p><strong>Week:</strong> ${settings.current_week || 1}</p>`;
            
            if (settings.roster_spots) {
                const roster = settings.roster_spots;
                infoHtml += `<p><strong>Roster:</strong> ${roster.QB || 1}QB/${roster.RB || 2}RB/${roster.WR || 2}WR/${roster.TE || 1}TE`;
                if (roster.FLEX) infoHtml += `/${roster.FLEX}FLEX`;
                if (roster.K) infoHtml += `/${roster.K}K`;
                if (roster.DEF) infoHtml += `/${roster.DEF}DEF`;
                infoHtml += '</p>';
            }
        } else {
            infoHtml += '<p>No configuration loaded</p>';
        }
        infoHtml += '</div>';
        
        infoHtml += '</div>';
        
        document.getElementById('system-info').innerHTML = infoHtml;
        
    } catch (error) {
        console.error('Error loading system info:', error);
        document.getElementById('system-info').innerHTML = 
            '<div class="alert alert-error">Error loading system information</div>';
    }
}

function createStatusItem(label, isActive) {
    const statusClass = isActive ? 'status-success' : 'status-warning';
    const statusText = isActive ? 'Yes' : 'No';
    return `
        <p style="margin-bottom: 8px;">
            <span class="status-indicator ${statusClass}"></span>
            ${label}: ${statusText}
        </p>
    `;
}
</script>

<style>
.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 0.95rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

input[type="checkbox"] {
    margin-right: 0.5rem;
}

@media (max-width: 768px) {
    .grid-2,
    .grid-3 {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}